(function(){function e(e,t,n,r,i){function s(e,t){if(t=t||0,!e[0])throw"findAndReplaceDOMText cannot handle zero-length matches";var n=e.index;if(t>0){var r=e[t];if(!r)throw"Invalid capture group";n+=e[0].indexOf(r),e[0]=r}return[n,n+e[0].length,[e[0]]]}function o(e){var t;if(3===e.nodeType)return e.data;if(p[e.nodeName])return"";if(t="",(h[e.nodeName]||d[e.nodeName])&&(t+="\n"),e=e.firstChild)do t+=o(e);while(e=e.nextSibling);return t}function u(e,t,n){var r,i,s,o,u=[],a=0,f=e,l=t.shift(),c=0;e:for(;;){if((h[f.nodeName]||d[f.nodeName])&&a++,3===f.nodeType&&(!i&&f.length+a>=l[1]?(i=f,o=l[1]-a):r&&u.push(f),!r&&f.length+a>l[0]&&(r=f,s=l[0]-a),a+=f.length),r&&i){if(f=n({startNode:r,startNodeIndex:s,endNode:i,endNodeIndex:o,innerNodes:u,match:l[2],matchIndex:c}),a-=i.length-o,r=null,i=null,u=[],l=t.shift(),c++,!l)break}else{if(!p[f.nodeName]&&f.firstChild){f=f.firstChild;continue}if(f.nextSibling){f=f.nextSibling;continue}}for(;;){if(f.nextSibling){f=f.nextSibling;break}if(f.parentNode===e)break e;f=f.parentNode}}}function a(e){var t;if("function"!=typeof e){var n=e.nodeType?e:c.createElement(e);t=function(e,t){var r=n.cloneNode(!1);return r.setAttribute("data-mce-index",t),e&&r.appendChild(c.createTextNode(e)),r}}else t=e;return function(e){var n,r,i,s=e.startNode,o=e.endNode,u=e.matchIndex;if(s===o){var a=s;i=a.parentNode,e.startNodeIndex>0&&(n=c.createTextNode(a.data.substring(0,e.startNodeIndex)),i.insertBefore(n,a));var f=t(e.match[0],u);return i.insertBefore(f,a),e.endNodeIndex<a.length&&(r=c.createTextNode(a.data.substring(e.endNodeIndex)),i.insertBefore(r,a)),a.parentNode.removeChild(a),f}n=c.createTextNode(s.data.substring(0,e.startNodeIndex)),r=c.createTextNode(o.data.substring(e.endNodeIndex));for(var l=t(s.data.substring(e.startNodeIndex),u),h=[],p=0,d=e.innerNodes.length;d>p;++p){var v=e.innerNodes[p],m=t(v.data,u);v.parentNode.replaceChild(m,v),h.push(m)}var g=t(o.data.substring(0,e.endNodeIndex),u);return i=s.parentNode,i.insertBefore(n,s),i.insertBefore(l,s),i.removeChild(s),i=o.parentNode,i.insertBefore(g,o),i.insertBefore(r,o),i.removeChild(o),g}}var f,l,c,h,p,d,v=[],m=0;if(c=t.ownerDocument,h=i.getBlockElements(),p=i.getWhiteSpaceElements(),d=i.getShortEndedElements(),l=o(t)){if(e.global)for(;f=e.exec(l);)v.push(s(f,r));else f=l.match(e),v.push(s(f,r));return v.length&&(m=v.length,u(t,v,a(n))),m}}function t(t){function n(){var e=tinymce.ui.Factory.create({type:"window",layout:"flex",pack:"center",align:"center",onClose:function(){t.focus(),o=!1,u.unmarkAllMatches()},buttons:[{text:"Find",onclick:function(){e.find("form")[0].submit()}},{text:"Replace",disabled:!0,onclick:function(){u.replace(e.find("#replace").value())||e.statusbar.items().slice(1).disabled(!0)}},{text:"Replace all",disabled:!0,onclick:function(){u.replaceAll(e.find("#replace").value()),e.statusbar.items().slice(1).disabled(!0)}},{type:"spacer",flex:1},{text:"Prev",disabled:!0,onclick:function(){u.prev()}},{text:"Next",disabled:!0,onclick:function(){u.next()}}],title:"Find and replace",items:{type:"form",padding:20,labelGap:30,spacing:10,onsubmit:function(t){var n,r,i,s,o;return t.preventDefault(),i=e.find("#case").checked(),o=e.find("#words").checked(),s=e.find("#find").value(),s.length?(s=s.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),s=o?"\\b"+s+"\\b":s,r=RegExp(s,i?"g":"gi"),n=u.markAllMatches(r),n?u.first():tinymce.ui.MessageBox.alert("Could not find the specified string."),e.statusbar.items().slice(1).disabled(0===n),void 0):(u.unmarkAllMatches(),e.statusbar.items().slice(1).disabled(!0),void 0)},items:[{type:"textbox",name:"find",size:40,label:"Find",value:t.selection.getNode().src},{type:"textbox",name:"replace",size:40,label:"Replace with"},{type:"checkbox",name:"case",text:"Match case",label:" "},{type:"checkbox",name:"words",text:"Whole words",label:" "}]}}).renderTo().reflow();o=!0}function r(e){var t=e.parentNode;t.insertBefore(e.firstChild,e),e.parentNode.removeChild(e)}function i(e,n){function r(){var r,o;for(r=n?t.getBody()[e?"firstChild":"lastChild"]:u[e?"endContainer":"startContainer"],o=new tinymce.dom.TreeWalker(r,t.getBody());r=o.current();){if(1==r.nodeType&&"SPAN"==r.nodeName&&null!==r.getAttribute("data-mce-index"))for(a=r.getAttribute("data-mce-index"),i=r.firstChild;r=o.current();){if(1==r.nodeType&&"SPAN"==r.nodeName&&null!==r.getAttribute("data-mce-index")){if(r.getAttribute("data-mce-index")!==a)return;s=r.firstChild}o[e?"next":"prev"]()}o[e?"next":"prev"]()}}var i,s,o=t.selection,u=o.getRng(!0),a=-1;return e=e!==!1,r(),i&&s&&(t.focus(),e?(u.setStart(i,0),u.setEnd(s,s.length)):(u.setStart(s,0),u.setEnd(i,i.length)),o.scrollIntoView(i.parentNode),o.setRng(u)),a}function s(e){e.parentNode.removeChild(e)}var o,u=this,a=-1;u.init=function(e){e.addMenuItem("searchreplace",{text:"Find and replace",shortcut:"Ctrl+F",onclick:n,separator:"before",context:"edit"}),e.addButton("searchreplace",{tooltip:"Find and replace",shortcut:"Ctrl+F",onclick:n}),e.shortcuts.add("Ctrl+F","",n)},u.markAllMatches=function(n){var r,i;return i=t.dom.create("span",{"class":"mce-match-marker","data-mce-bogus":1}),r=t.getBody(),u.unmarkAllMatches(r),e(n,r,i,!1,t.schema)},u.first=function(){return a=i(!0,!0),-1!==a},u.next=function(){return a=i(!0),-1!==a},u.prev=function(){return a=i(!1),-1!==a},u.replace=function(e,n,o){var u,f,c,h,p,d;if(-1===a&&(a=i(n)),d=i(n),c=t.getBody(),f=tinymce.toArray(c.getElementsByTagName("span")),f.length)for(u=0;f.length>u;u++)if(h=p=f[u].getAttribute("data-mce-index"),o||h===a)for(e.length?(f[u].firstChild.nodeValue=e,r(f[u])):s(f[u]);f[++u];){if(h=f[u].getAttribute("data-mce-index"),h!==p){u--;break}s(f[u])}return-1==d&&(d=i(n,!0)),a=d,o&&t.selection.setCursorLocation(t.getBody(),0),t.undoManager.add(),-1!==a},u.replaceAll=function(e){u.replace(e,!0,!0)},u.unmarkAllMatches=function(){var e,n,i;for(i=t.getBody(),n=i.getElementsByTagName("span"),e=n.length;e--;)i=n[e],i.getAttribute("data-mce-index")&&r(i)},t.on("beforeaddundo keydown",function(e){return o?(e.preventDefault(),!1):void 0})}tinymce.PluginManager.add("searchreplace",t)})();